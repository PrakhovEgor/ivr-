<!--Страница добавления действия-->
{% extends "base.html" %}


{% block content %}
<div class="d-flex flex-column align-items-center">
    <form action="" method="POST" enctype="multipart/form-data">
        <div class="container p-2">
            <h1 class="display-6">Чем Вы занимались сегодня?</h1>
            <input type="submit"
                   class="btn btn-{{['outline-', '', 'outline-', 'outline-', 'outline-'][status]}}success m-2"
                   name="watering" value="Полив">
            <input type="submit"
                   class="btn btn-{{['outline-', 'outline-', '', 'outline-', 'outline-'][status]}}success m-2"
                   name="planting" value="Посадка">
            <input type="submit"
                   class="btn btn-{{['outline-', 'outline-', 'outline-', '', 'outline-'][status]}}success m-2"
                   name="tending" value="Уход">
            <input type="submit"
                   class="btn btn-{{['outline-', 'outline-', 'outline-', 'outline-', ''][status]}}success m-2"
                   name="harvesting" value="Сбор урожая">
        </div>
        <div style="width:100%;overflow:hidden;">
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label class="col-form-label">Список растений:</label>
                </div>
                <div class="col-auto">
                    <select class="form-select" aria-label="Default select example"
                            name="all_or_user" id="all_or_user" oninput="checkInput()">
                        <option value="all" selected>Весь</option>
                        <option value="users">Ваш</option>
                    </select>
                </div>
            </div>
            <br>
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <input type="text" class="form-control" name="plant_input" value="{{ plant_input_placeholder }}"
                           id="search_field" oninput="checkInput()">
                </div>
                <div class="col-auto">
                    <input type="button" class="btn btn-success" name="search" value="Искать" id="search"
                           oninput="checkInput()">
                </div>
            </div>
            <div style="height:200px;width:100%;overflow-y:scroll;" id="plants_list">
            </div>
        </div>
        {% if status == 1 %}  <!--Если выбран полив-->
        <input type="submit" class="btn btn-success m-2" name="save_w" value="Сохранить">
        {% elif status == 2 %} <!--Если выбрана посадка-->
        <br>
        <input type="submit" class="btn btn-success m-2" name="continue_p" value="Продолжить">
        <hr>

        {% if plants_to_plant %}
        {% for plant in plants_to_plant %}
        <div class="container align-items-center">
            <div class="col-auto">
                <h1 class="display-6">{{ plant[1] }}</h1>
            </div>
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label>Вы посадили:</label>
                </div>
                <div class="col-auto">
                    <select class="form-select" aria-label="Default select example"
                            name="{{ plant[0]|string + '_type' }}">
                        <option value="seeds" selected>Семена</option>
                        <option value="sprouts">Ростки</option>
                    </select>
                </div>

                <div class="col-auto">
                    <label>Кол-во:</label>
                </div>
                <div class="col-auto">
                    <input value="1" min="1" max="1000" type="number" id="typeNumber" class="form-control"
                           name="{{plant[0]|string +'_count'}}">
                </div>
                <div class="col-auto">
                    <label>Фотография:</label>
                </div>
                <div class="col-auto">
                    <input type="file" name="image_{{plant[0]}}" accept=".png,.jpg,.jpeg">
                </div>
                <div class="col-auto">
                    <label>Комментарий:</label>
                </div>
                <div class="col-auto">
                    <textarea class="form-control" name="comment_{{plant[0]}}"></textarea>
                </div>
            </div>
        </div>
        <br>
        {% endfor %}
        <input type="submit" class="btn btn-success m-2" name="save_p" value="Сохранить">
        {% endif %}
        {% elif status == 3 %}  <!--Если выбран уход-->
        <br>
        <input type="submit" class="btn btn-success m-2" name="continue_t" value="Продолжить">
        <hr>
        {% if plants_to_plant %}
        {% for plant in plants_to_plant %}
        <div class="container align-items-center">
            <div class="col-auto">
                <h1 class="display-6">{{ plant[1] }}</h1>
            </div>
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label>Тип ухода:</label>
                </div>
                <div class="col-auto">
                    <select class="form-select" aria-label="Default select example"
                            name="{{ plant[0]|string + '_type' }}">
                        <option value="weeding">Прополка</option>
                        <option value="fertilizing" selected>Удобрение</option>
                        <option value="pest_control">Борьба с вредителями</option>
                        <option value="transplant">Пересадка</option>
                        <option value="pruning">Обрезка</option>
                    </select>
                </div>
                <div class="col-auto">
                    <label>Фотография:</label>
                </div>
                <div class="col-auto">
                    <input type="file" name="image_{{plant[0]}}" accept=".png,.jpg,.jpeg">
                </div>
                <div class="col-auto">
                    <label>Комментарий:</label>
                </div>
                <div class="col-auto">
                    <textarea class="form-control" name="comment_{{plant[0]}}"></textarea>
                </div>
            </div>
        </div>
        <br>
        {% endfor %}
        <input type="submit" class="btn btn-success m-2" name="save_t" value="Сохранить">
        {% endif %}
        {% elif status == 4 %} <!--Если выбран сбор урожая-->
        <br>
        <input type="submit" class="btn btn-success m-2" name="continue_h" value="Продолжить">
        <hr>
        {% if plants_to_plant %}
        {% for plant in plants_to_plant %}
        <div class="container align-items-center">
            <div class="col-auto">
                <h1 class="display-6">{{ plant[1] }}</h1>
            </div>
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label>Кол-во:</label>
                </div>
                <div class="col-auto">
                    <input value="1" min="1" max="1000" type="number" class="form-control"
                           name="{{plant[0]|string +'_count'}}">
                </div>
                <div class="col-auto">
                    <label>Вес:</label>
                </div>
                <div class="col-auto">
                    <input value="1" min="0.000" max="1000" step="0.1" type="number"
                           class="form-control"
                           name="{{plant[0]|string +'_weight'}}">
                </div>
                <div class="col-auto">
                    <label>Кг</label>
                </div>
                <div class="col-auto">
                    <label>Фотография:</label>
                </div>
                <div class="col-auto">
                    <input type="file" name="image_{{plant[0]}}" accept=".png,.jpg,.jpeg">
                </div>
                <div class="col-auto">
                    <label>Комментарий:</label>
                </div>
                <div class="col-auto">
                    <textarea class="form-control" name="comment_{{plant[0]}}"></textarea>
                </div>
            </div>
        </div>
        <br>
        {% endfor %}
        <input type="submit" class="btn btn-success m-2" name="save_h" value="Сохранить">
        {% endif %}
        {% endif %}
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => { // Обработка поиска растений
        let plants = {{plants | tojson}};
        let container = document.getElementById("plants_list");
        let user_plants = {{user_plants}};
        let allOrUserSelect = document.getElementById("all_or_user");

        function updatePlantList() {
            container.innerHTML = '';
            let promt = document.getElementById("search_field").value.toLowerCase();
            let allOrUser = allOrUserSelect.value;
            for (let i = 0; i < plants.length; i++) {
                let plant = plants[i];
                let [plantId, plantName, checked] = plant;
                if (plantName.toLowerCase().includes(promt) && (allOrUser === "all" || user_plants.includes(plantId))) {
                    let input = document.createElement("input");
                    input.type = "checkbox";
                    input.name = plantId;
                    input.value = plantName;
                    input.checked = checked === "checked";

                    let label = document.createElement("label");
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(plantName));

                    container.appendChild(label);
                    container.appendChild(document.createElement("br"));
                }
            }
        }

        allOrUserSelect.addEventListener("input", updatePlantList);
        document.getElementById("search_field").addEventListener("input", updatePlantList);
        updatePlantList();
    });
</script>
{% endblock %}